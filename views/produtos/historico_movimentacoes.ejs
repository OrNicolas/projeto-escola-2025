<%- include('../includes/header.ejs', { titulo: 'Movimentações de Estoque' }) %>

    <style>
        /* Cores personalizadas (mantendo o tema Batman) */
        .bg-batman-dark {
            background-color: #1a1a1a;
        }

        .text-batman-yellow {
            color: #FFD700;
        }

        .bg-batman-yellow {
            background-color: #FFD700;
            color: #1a1a1a;
        }

        .hover\:bg-batman-yellow-dark:hover {
            background-color: #e0b400;
        }
    </style>

    <main class="min-h-screen bg-batman-dark text-white p-6 md:p-10 mb-0">
        <div class="max-w-4xl mx-auto">
            <a href="/produtos/editar/<%= produto.id_produto %>"
                class="text-batman-yellow hover:text-white transition duration-150 flex items-center mb-4">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Voltar para Edição do Produto
            </a>

            <h2 class="text-4xl font-extrabold border-b-4 border-batman-yellow pb-3 mb-8 text-batman-yellow">
                Movimentações de Estoque: <%= produto.nome %>
            </h2>

            <% if (mensagem) { %>
                <div class="bg-green-700 text-white p-4 rounded-lg mb-4 font-bold">
                    <%= mensagem %>
                </div>
                <% } %>

                    <div class="mb-10 p-6 rounded-xl shadow-2xl bg-gray-900 border border-gray-700">
                        <h3 class="text-2xl font-bold mb-4 text-white">Registrar Nova Movimentação</h3>
                        <form action="/produtos/movimentar" method="post"
                            class="space-y-4 md:flex md:space-y-0 md:space-x-4">
                            <input type="hidden" name="id_produto" value="<%= produto.id_produto %>">

                            <div class="flex-1 space-y-1">
                                <label for="tipo_movimentacao"
                                    class="block text-sm font-medium text-gray-300">Tipo:</label>
                                <select name="tipo_movimentacao" required
                                    class="w-full p-3 rounded-lg border-2 bg-gray-800 text-white focus:ring-2 focus:ring-batman-yellow focus:border-batman-yellow transition duration-150 border-gray-700 py-2">
                                    <option value="ENTRADA">Entrada (Adicionar)</option>
                                    <option value="SAIDA">Saída (Remover)</option>
                                </select>
                            </div>

                            <div class="flex-1 space-y-1">
                                <label for="quantidade"
                                    class="block text-sm font-medium text-gray-300">Quantidade:</label>
                                <input type="number" name="quantidade" min="1" required
                                    class="w-full p-3 rounded-lg border-2 bg-gray-800 text-white focus:ring-2 focus:ring-batman-yellow focus:border-batman-yellow transition duration-150 border-gray-700 py-2">
                            </div>

                            <div class="flex items-end pt-5">
                                <button type="submit"
                                    class="w-full md:w-auto py-3 px-8 rounded-lg bg-red-700 text-white font-bold shadow-xl hover:bg-red-600 transition duration-300">
                                    Registrar
                                </button>
                            </div>
                        </form>
                    </div>

                    <h3 class="text-2xl font-bold mb-4 text-white">Histórico (Estoque Atual: <%=
                            produto.quantidade_estoque %>)</h3>

                    <div class="overflow-x-auto rounded-xl shadow-2xl border border-gray-700">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-800">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                        Data/Hora</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                        Tipo</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                        Quantidade</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                        Responsável</th>
                                </tr>
                            </thead>
                            <tbody class="bg-gray-900 divide-y divide-gray-700">
                                <% if (movimentacoes && movimentacoes.length> 0) { %>
                                    <% for (let mov of movimentacoes) { %>
                                        <tr>
                                          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
    <% 
        /* 1. Obtém a string do banco (ex: "2025-12-09 08:22:25" ) */
        const dataString = mov.data_movimentacao; 

        /* 2. Adiciona o offset do fuso horário brasileiro (UTC-3) à string. 
           Isso força o JS a interpretar o horário como local. */
        const dataComOffset = dataString + ' -03:00'; 

        /* 3. Cria o objeto Date usando a string corrigida */
        const dataMovimentacao = new Date(dataComOffset); 

        const options = {
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit', 
            hour12: false // Usa formato 24 horas 
        }; 
    %>
    <%= dataMovimentacao.toLocaleString('pt-BR', options) %>
</td>
                                            <td
                                                class="px-6 py-4 whitespace-nowrap text-sm font-bold <%= mov.tipo === 'ENTRADA' ? 'text-green-400' : 'text-red-400' %>">
                                                <%= mov.tipo %>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">
                                                <%= mov.quantidade %>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                                <%= mov.usuario_nome %>
                                            </td>
                                        </tr>
                                        <% } %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                                                        Nenhuma movimentação registrada para este produto.
                                                    </td>
                                                </tr>
                                                <% } %>
                            </tbody>
                        </table>
                    </div>
        </div>
    <div class="paginacao">
        <% if (pgAtual> 1) { %>
            <a href="/produtos/<%= produto.id_produto %>/movimentacoes?page=<%= pgAtual - 1 %>" class="btn-paginar">Anterior</a>
        <% } %>
    
                <span>Página <%= pgAtual %> de <%= totalPgs %></span>
    
                 <% if (pgAtual < totalPgs) { %>
                <a href="/produtos/<%= produto.id_produto %>/movimentacoes?page=<%= pgAtual + 1 %>"
                        class="btn-paginar">Próxima</a>
                    <% } %>
                        </div>
    </main>

    <%- include('../includes/footer.ejs') %>